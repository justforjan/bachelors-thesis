---
title: "BA - Visualization"
output: html_notebook
---

## load libraries and other stuff

```{r}
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(factoextra)

source("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/code/functions.R")

regions <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/regions.csv", show_col_types = FALSE)

Africa <- regions$country[regions$continent == "Africa"]
Europe <- regions$country[regions$continent == "Europe"]
Americas <- regions$country[regions$continent == "Americas"]
Asia <- regions$country[regions$continent == "Asia"]
Oceania <- regions$country[regions$continent == "Oceania"]
EU <- regions$country[regions$EU == TRUE]
OECD <- regions$country[regions$OECD == TRUE]
```

## load data

```{r}
filename_vrs <- "dea_results_113_io_vrs.csv"
filename_crs <- "dea_results_113_io_crs.csv"

data_vrs <- read_csv(paste("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/", filename_vrs, sep = ""), show_col_types = FALSE)
data_crs <- read_csv(paste("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/", filename_crs, sep = ""), show_col_types = FALSE)
```

## Some stats

```{r}
summary(data_vrs)
```

```{r}
summary(data_crs)
```

## Problems

at first sight

-   target non-murder rate above 100 in crs data set

-   target mean years in school sometimes ridiculously high

-   Same goes for life expectancy

# Preparation of several tables

## Add ranks

```{r}
data_crs <- data_crs %>% mutate(rank = min_rank(desc(efficiencies)))
data_vrs <- data_vrs %>% mutate(rank = min_rank(desc(efficiencies)))

data_crs <- data_crs %>% relocate(rank, .after = efficiencies)
data_vrs <- data_vrs %>% relocate(rank, .after = efficiencies)
```

## New table: Countries vs. years

```{r}
data_crs_wider_rank <- data_crs[c("country", "year", "rank")] %>% pivot_wider(names_from = year, values_from = rank)

data_crs_wider_rank <- data_crs_wider_rank[c("country", as.character(c(1990:2016)))]

data_crs_wider_eff <- data_crs[c("country", "year", "efficiencies")] %>% pivot_wider(names_from = year, values_from = efficiencies)

data_crs_wider_eff <- data_crs_wider_eff[c("country", as.character(c(1990:2016)))]
```

## Recalculate foreign investment columns

```{r}
# mirror = 253.25
# 
# data_crs$foreign_investment <- 2 * mirror - data_crs$foreign_investment - 57.4
# data_crs$target_input.foreign_investment <- 2 * mirror - data_crs$target_input.foreign_investment - 57.4
# 
# data_vrs$foreign_investment <- 2 * mirror - data_vrs$foreign_investment - 57.4
# data_vrs$target_input.foreign_investment <- 2 * mirror - data_vrs$target_input.foreign_investment - 57.4

# # crs
# data_crs$foreign_investment <- (data_crs$foreign_investment * (-1)) + 450
# 
# data_crs$target_input.foreign_investment <- data_crs$target_input.foreign_investment * (-1) + 450
# 
# # vrs
# data_vrs$foreign_investment <- (data_vrs$foreign_investment * (-1)) + 450
# 
# data_vrs$target_input.foreign_investment <- data_vrs$target_input.foreign_investment * (-1) + 450

# crs
data_crs$foreign_investment <- data_crs$foreign_investment - 58.5

data_crs$target_input.foreign_investment <- data_crs$target_input.foreign_investment - 58.5

# vrs
data_vrs$foreign_investment <- data_vrs$foreign_investment - 58.5

data_vrs$target_input.foreign_investment <- data_vrs$target_input.foreign_investment - 58.5
```

## Make very long datasets

```{r}
data_verylong_input <- data_crs %>%
  select(dmu, country, year, efficiencies, CO2, material_footprint, foreign_investment, government_debt) %>%
  pivot_longer(cols = c("efficiencies", "CO2", "material_footprint", "foreign_investment", "government_debt"), names_to = "indicator")

data_verylong_output <- data_crs %>%
  select(dmu, country, year, efficiencies, life_expectancy, income, mean_years_in_school, murder, income_share_20) %>%
  pivot_longer(cols = c("efficiencies", "life_expectancy", "income", "mean_years_in_school", "murder", "income_share_20"), names_to = "indicator")
```

## Normalize efficiency

Germany 1991 as basis

```{r}
data_crs_normal <- data_crs
data_crs_normal["efficiencies"] <- data_crs_normal["efficiencies"] / as.numeric(filter(data_crs, dmu == "Germany_1991")["efficiencies"])
```

# Analyses

## VRS vs. CRS

### Same order?

```{r}
identical(data_vrs$rank, data_crs$rank)
```

Ranks are not identical.

```{r}
(data_vrs$efficiencies - data_crs$efficiencies) < 0
```

## Means

### Means per country

```{r}
means_country_crs <- data_crs %>%
  select(country,efficiencies, CO2, material_footprint, foreign_investment, government_debt, life_expectancy, income, mean_years_in_school, murder, income_share_20) %>%
  group_by(country) %>%
  summarize(across(everything(), mean))
```

### Means per year

```{r}
means_year_crs <- data_crs %>%
  select(year,efficiencies, CO2, material_footprint, foreign_investment, government_debt, life_expectancy, income, mean_years_in_school, murder, income_share_20) %>%
  group_by(year) %>%
  summarize(across(everything(), mean))
```

Visualization of average development over time

```{r}
means_year_crs %>%
  pivot_longer(cols = c("efficiencies", "CO2", "material_footprint", "foreign_investment", "government_debt", "life_expectancy", "income", "mean_years_in_school", "murder", "income_share_20"), names_to = "indicator") %>%
  ggplot(aes(year, value))+
  geom_line()+
  facet_wrap(vars(indicator), scales = "free_y")
```

CO2 emissions per person have been decreasing since the 00s.

Mean years in school have been increasing

Average efficiencies higher in the the 90s than in nowdays, but rising again? Why??

### Add average efficiency to wide data frames

```{r}
# avererage efficiencies for crs data set
crs_eff <- data_crs[c("country", "efficiencies")] %>%
  group_by(country) %>%
  summarise(across(everything(), mean))

# merge efficienies and wide crs rank data set
data_crs_wider_rank <- merge(data_crs_wider_rank, crs_eff, by = "country")
data_crs_wider_rank <- data_crs_wider_rank %>% relocate(efficiencies, .after = country)
colnames(data_crs_wider_rank)[2] <- "average_efficiency"

# add rank based on average efficiencies
data_crs_wider_rank <- data_crs_wider_rank %>% mutate(rank = min_rank(desc(average_efficiency)))
data_crs_wider_rank <- data_crs_wider_rank %>% relocate(rank)

# merge efficienies and wide crs efficiency data set
data_crs_wider_eff <- merge(data_crs_wider_eff, crs_eff, by = "country")
data_crs_wider_eff <- data_crs_wider_eff %>% relocate(efficiencies, .after = country)
colnames(data_crs_wider_eff)[2] <- "average_efficiency"

# add rank based on average efficiencies
data_crs_wider_eff <- data_crs_wider_eff %>% mutate(rank = min_rank(desc(average_efficiency)))
data_crs_wider_eff <- data_crs_wider_eff %>% relocate(rank)

```

## Clustering

### Clustering of all DMUs

```{r}
data.lables <- data_crs$dmu

data_scale <- scale(data_crs[6:ncol(data_crs)-1])

# How many cluster do we need?
fviz_nbclust(data_scale, kmeans, method = "wss")
```

It is difficult to make out the ideal number of cluster but 6 seems to be one of the better options.

```{r}
km.out <- kmeans(data_scale, centers = 6, nstart = 100)
# print(km.out)
```

```{r}
km.clusters <- km.out$cluster
rownames(data_scale) <- data.lables
fviz_cluster(list(data=data_scale, cluster=km.clusters))
```

```{r}
data_crs_cluster <- data_crs
data_crs_cluster$cluster <- km.clusters
```

What countries are in the cluster?

```{r}
cluster_country <- data_crs_cluster %>%
  group_by(cluster)%>%
  summarize(unique_countries = unique(country))

cluster_1 <- cluster_country %>%
  filter(cluster == 1) %>%
  select(unique_countries)

cluster_2 <- cluster_country %>%
  filter(cluster == 2) %>%
  select(unique_countries)

cluster_3 <- cluster_country %>%
  filter(cluster == 3) %>%
  select(unique_countries)

cluster_4 <- cluster_country %>%
  filter(cluster == 4) %>%
  select(unique_countries)

cluster_5 <- cluster_country %>%
  filter(cluster == 5) %>%
  select(unique_countries)

cluster_6 <- cluster_country %>%
  filter(cluster == 6) %>%
  select(unique_countries)
```

### Clustering of average country values

```{r}
data.lables_mean <- means_country_crs$country

data_scale_mean <- scale(means_country_crs[3:ncol(means_country_crs)])

# How many cluster do we need?
fviz_nbclust(data_scale, kmeans, method = "wss")
```

3 clusters makes the most sense

```{r}
km.out_mean <- kmeans(data_scale_mean, centers = 6, nstart = 100)
# print(km.out)

km.clusters_mean <- km.out_mean$cluster
rownames(data_scale_mean) <- data.lables_mean
fviz_cluster(list(data=data_scale_mean, cluster=km.clusters_mean))
```

## Most efficient, Least efficient, big changes

On average

```{r}
means_country_crs$country[means_country_crs$efficiencies == max(means_country_crs$efficiencies)]
means_country_crs$country[means_country_crs$efficiencies == min(means_country_crs$efficiencies)]
```

Individual DMUs

```{r}
head(data_crs[order(data_crs$rank),],70)
tail(data_crs[order(data_crs$rank),],10)
```

```{r}
unique(head(data_crs[order(data_crs$rank),],70)$country)
unique(tail(data_crs[order(data_crs$rank),],10)$country)
```

```{r}
# data_crs %>%
#   group_by(country) %>%
#   filter((max(efficiencies - min(efficiencies) >= 0.2)))
```

## Deep-dive into some countries

Very efficient, very in-efficient, big change in efficiency over time

Countries to consider:

| 100% efficiency in some years |                           | Lowest efficiency in some years |                 | Big change in efficiency |
|---------------|---------------|---------------|---------------|---------------|
| Albania                       | 1996-1998                 | Malta                           | 2006-2009, 2011 |                          |
| Armenia                       | 2006-2008                 | Cyprus                          | 10,12,12,14,15  |                          |
| Belarus                       | 1998-2001                 |                                 |                 |                          |
| Denmark                       | 1997,2004,2012            |                                 |                 |                          |
| Estonia                       | 2003-2008                 |                                 |                 |                          |
| Germany                       | 2011,2014                 |                                 |                 |                          |
| Kazakhztan                    | 2005,2006,2008            |                                 |                 |                          |
| Moldova (very often 100%)     | 1999-2016                 |                                 |                 |                          |
| Switzerland                   | 1990-1993,1997, 2011-2013 |                                 |                 |                          |
|                               |                           |                                 |                 |                          |

### Albania

Albania is in the years 1996 to 1998 fully efficient. As we can see in the following plot this this coincides with relatively low inputs.

```{r}
deepdive_input("Albania")
deepdive_output("Albania")
```

Interestingly, the outputs do not all follow the same pattern. Income, life expectancy and mean years in school are the lowest in the beginning.

### Armenia

```{r}
deepdive_input("Armenia")
deepdive_output("Armenia")
```

### Denmark

```{r}
deepdive_input("Denmark")
deepdive_output("Denmark")
```

### Estonia

```{r}
deepdive_input("Estonia")
deepdive_output("Estonia")
```

### Germany

```{r}
deepdive_input("Germany")
deepdive_output("Germany")
```

### Kazakhstan

```{r}
deepdive_input("Kazakhstan")
deepdive_output("Kazakhstan")
```

### Moldova

```{r}
deepdive_input("Moldova")
deepdive_output("Moldova")
```

## Correlation between efficiency and input factors

CO2

```{r}
cor(data_crs[c("CO2", "efficiencies")])
```

Slight negative correlation (-0.4). The more CO2 emissions per person, the worse the

Foreign Direct Investment

```{r}
cor(data_crs[c("foreign_investment", "efficiencies")])
```

No correlation between FDI and the resulting efficiencies

Material footprint

```{r}
cor(data_crs[c("material_footprint", "efficiencies")])
```

Small correlation (-0.3)

```{r}
cor(data_crs[c("government_debt", "efficiencies")])
```

## Performance of country-year combinations with high inputs

```{r}
CO2_upperQuantile <- subset(data_crs, CO2 > as.numeric(quantile(data_crs$CO2)[4]))
CO2_lowerQuantile <- subset(data_crs, CO2 <= as.numeric(quantile(data_crs$CO2)[2]))

mean(CO2_upperQuantile$efficiencies)
mean(CO2_lowerQuantile$efficiencies)
```

```{r}
MF_upperQuantile <- subset(data_crs, material_footprint > as.numeric(quantile(data_crs$material_footprint)[4]))
MF_lowerQuantile <- subset(data_crs, material_footprint <= as.numeric(quantile(data_crs$material_footprint)[2]))

mean(MF_upperQuantile$efficiencies)
mean(MF_lowerQuantile$efficiencies)
```

```{r}
FDI_upperQuantile <- subset(data_crs, foreign_investment > as.numeric(quantile(data_crs$foreign_investment)[4]))
FDI_lowerQuantile <- subset(data_crs, foreign_investment <= as.numeric(quantile(data_crs$foreign_investment)[2]))

mean(FDI_upperQuantile$efficiencies)
mean(FDI_lowerQuantile$efficiencies)
```

```{r}
DEBTS_upperQuantile <- subset(data_crs, government_debt > as.numeric(quantile(data_crs$government_debt)[4]))
DEBTS_lowerQuantile <- subset(data_crs, government_debt <= as.numeric(quantile(data_crs$government_debt)[2]))

mean(DEBTS_upperQuantile$efficiencies)
mean(DEBTS_lowerQuantile$efficiencies)
```

## Correlation with BIP/HDI/HPI

### **GDP (income/gdp per person)**

```{r}
cor(data_crs$income, data_crs$efficiencies)
```

Almost no correlation

### **HDI**

```{r}
hdi <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/preprocessed_data/hdi.csv", show_col_types = FALSE)

hdi_merge <- merge(data_crs[c("dmu", "efficiencies")], hdi, by = "dmu", all.x = TRUE)

colnames(hdi_merge)[3] <- "hdi"

hdi_merge <- merge(hdi_merge, data_crs_cluster[c("dmu", "cluster", "country")])

hdi_merge$cluster <- as.character(hdi_merge$cluster)

cor(hdi_merge[2:3])
```

Slight negative correlation between efficiencies and HDI.

Visualization, color-coded by previously clusters, continents

```{r}
# Color-coded by cluster
hdi_merge %>%
  ggplot(aes(efficiencies, hdi))+
  geom_point(aes(
    color = cluster
  ))
```

The clusters seemto very well represent the different development classes based on the HDI

```{r}
hdi_merge %>%
  ggplot(aes(cluster, hdi))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(color = efficiencies))
```

```{r}
# Color-coded by continent
hdi_merge %>%
  ggplot(aes(efficiencies, hdi))+
  geom_point(aes(
    color = cluster
  ))
```

## Which countries improved, which got worse?

Development of efficiency over time compares to first year

```{r}
change_eff <- data_crs_wider_eff %>%
  filter(!is.na(`1990`))

change_eff[4:ncol(change_eff)] <- change_eff[4:ncol(change_eff)] / change_eff[,4]

change_eff <- pivot_longer(change_eff, cols = colnames(change_eff)[4:ncol(change_eff)], names_to = "year")

change_eff <- drop_na(change_eff)

change_eff <- merge_dmu(change_eff, rm.country_year = FALSE)
```

```{r}
change_eff %>%
  filter(country %in% c("Denmark", "Austria", "Australia", "Belgium", "Ireland"))%>%
  ggplot(aes(year, value, group = country))+
  geom_line(aes(
    color = country
  ))+
  geom_hline(yintercept=1, linetype="dashed")+
  scale_x_discrete(breaks = seq(1990, 2020, by = 5))
```

## 1on1 DEA vs full DEA

```{r}

oneonone <- data_crs %>%
  select(dmu, efficiencies)

names(oneonone)[length(names(oneonone))] <- "full_dea"

for (i in 1:4) {
  for (j in 1:5) {
    
    # read file and merge it
    oneonone <- merge(oneonone, select(read_csv(paste("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/dea_results_113_io_crs_", as.character(i),  as.character(j), ".csv", sep = ""), show_col_types = FALSE), dmu, efficiencies), by = "dmu")
    
    # rename new column  
    names(oneonone)[ncol(oneonone)] <- paste(as.character(i), as.character(j), sep = "")
  }
}
```

```{r}
oneonone_correlation <- as.data.frame(cor(oneonone[2:ncol(oneonone)]))

write_csv(oneonone_correlation, "D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/oneonone_correlation.csv" )
```

![](oneonone.PNG)

Sames output means same efficiency.

## years vs efficiency

```{r}
data_crs %>%
  # filter(efficiencies <= quantile(data_crs$efficiencies)[2]) %>%
  filter(country %in% c("Germany", "United States", "France", "Thailand", "Ghana", "South Africa")) %>%
  ggplot(aes(year, efficiencies))+
  geom_point(aes(
    color=country
    )
  )+
  geom_line(aes(
    color=country
    )
  )

```

## Efficiencies per continent (all years)

```{r}
data_crs %>%
  # filter(continent == "Africa") %>%
  # filter(year %in% c(1990:1999)) %>%

  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(
                color=year
              )
              )
```

```{r}
data_crs %>%
  # filter(continent == "Africa") %>%
  filter(year %in% c(1990:1999)) %>%

  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(
                color=year
              )
              )
```

```{r}
data_crs %>%
  # filter(continent == "Africa") %>%
  filter(year %in% c(2000:2009)) %>%

  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(
                color=year
              )
              )
```

```{r}

data_crs %>%
  # filter(continent == "Africa") %>%
  filter(year %in% c(2010:2019)) %>%

  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(
                color=year
              )
              )


```

In 90s not data about Africa, in 10 no data about Americas...not even USA
