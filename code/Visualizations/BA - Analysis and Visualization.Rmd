---
title: "BA - Visualization"
output: html_notebook
---

## load libraries and other stuff

```{r}
library(tidyverse)
library(ggplot2)
library(gridExtra)

source("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/code/functions.R")

regions <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/regions.csv", show_col_types = FALSE)

Africa <- regions$country[regions$continent == "Africa"]
Europe <- regions$country[regions$continent == "Europe"]
Americas <- regions$country[regions$continent == "Americas"]
Asia <- regions$country[regions$continent == "Asia"]
Oceania <- regions$country[regions$continent == "Oceania"]
EU <- regions$country[regions$EU == TRUE]
OECD <- regions$country[regions$OECD == TRUE]
```

## load data

```{r}
filename_vrs <- "dea_results_113_io_vrs.csv"
filename_crs <- "dea_results_113_io_crs.csv"

data_vrs <- read_csv(paste("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/", filename_vrs, sep = ""), show_col_types = FALSE)
data_crs <- read_csv(paste("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/", filename_crs, sep = ""), show_col_types = FALSE)
```

## Some stats

```{r}
summary(data_vrs)
```

```{r}
summary(data_crs)
```

## Problems

-   target non-murder rate above 100 in crs data set

-   target mean years in school sometimes ridiculously high

-   Same goes for life expectancy

# Preparation of several data

## Add ranks

```{r}
data_crs <- data_crs %>% mutate(rank = min_rank(desc(efficiencies)))
data_vrs <- data_vrs %>% mutate(rank = min_rank(desc(efficiencies)))

data_crs <- data_crs %>% relocate(rank, .after = efficiencies)
data_vrs <- data_vrs %>% relocate(rank, .after = efficiencies)
```

## New table: Countries vs. years with

```{r}
data_crs_wider_rank <- data_crs[c("country", "year", "rank")] %>% pivot_wider(names_from = year, values_from = rank)

data_crs_wider_rank <- data_crs_wider_rank[c("country", as.character(c(1990:2016)))]

data_crs_wider_eff <- data_crs[c("country", "year", "efficiencies")] %>% pivot_wider(names_from = year, values_from = efficiencies)

data_crs_wider_eff <- data_crs_wider_eff[c("country", as.character(c(1990:2016)))]
```

## Recalculate foreign investment columns

```{r}
# mirror = 253.25
# 
# data_crs$foreign_investment <- 2 * mirror - data_crs$foreign_investment - 57.4
# data_crs$target_input.foreign_investment <- 2 * mirror - data_crs$target_input.foreign_investment - 57.4
# 
# data_vrs$foreign_investment <- 2 * mirror - data_vrs$foreign_investment - 57.4
# data_vrs$target_input.foreign_investment <- 2 * mirror - data_vrs$target_input.foreign_investment - 57.4

# # crs
# data_crs$foreign_investment <- (data_crs$foreign_investment * (-1)) + 450
# 
# data_crs$target_input.foreign_investment <- data_crs$target_input.foreign_investment * (-1) + 450
# 
# # vrs
# data_vrs$foreign_investment <- (data_vrs$foreign_investment * (-1)) + 450
# 
# data_vrs$target_input.foreign_investment <- data_vrs$target_input.foreign_investment * (-1) + 450

# crs
data_crs$foreign_investment <- data_crs$foreign_investment - 58.5

data_crs$target_input.foreign_investment <- data_crs$target_input.foreign_investment - 58.5

# vrs
data_vrs$foreign_investment <- data_vrs$foreign_investment - 58.5

data_vrs$target_input.foreign_investment <- data_vrs$target_input.foreign_investment - 58.5
```

##  Make very long datasets

```{r}
data_verylong_input <- data_crs %>%
  select(dmu, country, year, efficiencies, CO2, material_footprint, foreign_investment, government_debt) %>%
  pivot_longer(cols = c("efficiencies", "CO2", "material_footprint", "foreign_investment", "government_debt"), names_to = "indicator")

data_verylong_output <- data_crs %>%
  select(dmu, country, year, efficiencies, life_expectancy, income, mean_years_in_school, murder, income_share_20) %>%
  pivot_longer(cols = c("efficiencies", "life_expectancy", "income", "mean_years_in_school", "murder", "income_share_20"), names_to = "indicator")
```

# Analyses

## Means

### Means per country

```{r}
means_country_crs <- data_crs %>%
  select(country,efficiencies, CO2, material_footprint, foreign_investment, government_debt, life_expectancy, income, mean_years_in_school, murder, income_share_20) %>%
  group_by(country) %>%
  summarize(across(everything(), mean))
```

### Means per year

```{r}
means_year_crs <- data_crs %>%
  select(year,efficiencies, CO2, material_footprint, foreign_investment, government_debt, life_expectancy, income, mean_years_in_school, murder, income_share_20) %>%
  group_by(year) %>%
  summarize(across(everything(), mean))
```

## Average efficiency per country

```{r}
# avererage efficiencies for crs data set
crs_eff <- data_crs[c("country", "efficiencies")] %>%
  group_by(country) %>%
  summarise(across(everything(), mean))

# merge efficienies and wide crs rank data set
data_crs_wider_rank <- merge(data_crs_wider_rank, crs_eff, by = "country")
data_crs_wider_rank <- data_crs_wider_rank %>% relocate(efficiencies, .after = country)
colnames(data_crs_wider_rank)[2] <- "average_efficiency"

# add rank based on average efficiencies
data_crs_wider_rank <- data_crs_wider_rank %>% mutate(rank = min_rank(desc(average_efficiency)))
data_crs_wider_rank <- data_crs_wider_rank %>% relocate(rank)

# merge efficienies and wide crs efficiency data set
data_crs_wider_eff <- merge(data_crs_wider_eff, crs_eff, by = "country")
data_crs_wider_eff <- data_crs_wider_eff %>% relocate(efficiencies, .after = country)
colnames(data_crs_wider_eff)[2] <- "average_efficiency"

# add rank based on average efficiencies
data_crs_wider_eff <- data_crs_wider_eff %>% mutate(rank = min_rank(desc(average_efficiency)))
data_crs_wider_eff <- data_crs_wider_eff %>% relocate(rank)

```

Germany 1990 as 100%

```{r}
data_crs_normal <- data_crs
data_crs_normal["efficiencies"] <- data_crs_normal["efficiencies"] / as.numeric(filter(data_crs, dmu == "Germany_1991")["efficiencies"])
```

## Most efficient, Least efficient

```{r}
head(data_crs[order(data_crs$rank),],70)
tail(data_crs[order(data_crs$rank),],10)
```

```{r}
unique(head(data_crs[order(data_crs$rank),],70)$country)
```

## Why are efficient countries efficient?

...and non-efficient ones non-efficient

Albania is in the years 1996 to 1998 fully efficient. As we can see in the following plot this this coincides with relatively low inputs.

```{r}
deepdive_input("Albania")
```

Interestingly, the outputs do not all follow the same pattern. Income, life expectancy and mean years in school are the lowest in the beginning.

```{r}
deepdive_output("Albania")
```

## Correlation between efficiency and input factors

CO2

```{r}
cor(data_crs[c("CO2", "efficiencies")])
```

Slight negative correlation (-0.4). The more CO2 emissions per person, the worse the

Foreign Direct Investment

```{r}
cor(data_crs[c("foreign_investment", "efficiencies")])
```

No correlation between FDI and the resulting efficiencies

Material footprint

```{r}
cor(data_crs[c("material_footprint", "efficiencies")])
```

Small correlation (-0.3)

## Performance of country-year combinations with high inputs

```{r}
CO2_upperQuantile <- subset(data_crs, CO2 > as.numeric(quantile(data_crs$CO2)[4]))
CO2_lowerQuantile <- subset(data_crs, CO2 <= as.numeric(quantile(data_crs$CO2)[2]))

mean(CO2_upperQuantile$efficiencies)
mean(CO2_lowerQuantile$efficiencies)
```

```{r}
MF_upperQuantile <- subset(data_crs, material_footprint > as.numeric(quantile(data_crs$material_footprint)[4]))
MF_lowerQuantile <- subset(data_crs, material_footprint <= as.numeric(quantile(data_crs$material_footprint)[2]))

mean(MF_upperQuantile$efficiencies)
mean(MF_lowerQuantile$efficiencies)
```

```{r}
FDI_upperQuantile <- subset(data_crs, foreign_investment > as.numeric(quantile(data_crs$foreign_investment)[4]))
FDI_lowerQuantile <- subset(data_crs, foreign_investment <= as.numeric(quantile(data_crs$foreign_investment)[2]))

mean(FDI_upperQuantile$efficiencies)
mean(FDI_lowerQuantile$efficiencies)
```

```{r}
DEBTS_upperQuantile <- subset(data_crs, government_debt > as.numeric(quantile(data_crs$government_debt)[4]))
DEBTS_lowerQuantile <- subset(data_crs, government_debt <= as.numeric(quantile(data_crs$government_debt)[2]))

mean(DEBTS_upperQuantile$efficiencies)
mean(DEBTS_lowerQuantile$efficiencies)
```

## Correlation with BIP/HDI/HPI

**GDP (income/gdp per person)**

```{r}
cor(data_crs$income, data_crs$efficiencies)
```

Almost no correlation

**HDI**

```{r}
hdi <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/preprocessed_data/hdi.csv", show_col_types = FALSE)

hdi_merge <- merge(data_crs[c("dmu", "efficiencies")], hdi, by = "dmu", all.x = TRUE)

cor(hdi_merge$efficiencies, hdi_merge$value)
```

Slight negative correlation between efficiencies and HDI

## Which countries improved, which got worse?

Development of efficiency over time compares to first year

```{r}
change_eff <- data_crs_wider_eff %>%
  filter(!is.na(`1990`))

change_eff[4:ncol(change_eff)] <- change_eff[4:ncol(change_eff)] / change_eff[,4]

change_eff <- pivot_longer(change_eff, cols = colnames(change_eff)[4:ncol(change_eff)], names_to = "year")

change_eff <- drop_na(change_eff)

change_eff <- merge_dmu(change_eff, rm.country_year = FALSE)
```

```{r}
change_eff %>%
  filter(country %in% c("Denmark", "Austria", "Australia", "Belgium", "Ireland"))%>%
  ggplot(aes(year, value, group = country))+
  geom_line(aes(
    color = country
  ))+
  geom_hline(yintercept=1, linetype="dashed")+
  scale_x_discrete(breaks = seq(1990, 2020, by = 5))
```

## Deep-dive into some countries

Make data set even longer :)

### Germany

```{r}
deepdive_input("Germany")

```

### Denmark

```{r}
deepdive_input("Denmark")
```

### USA

```{r}
deepdive_input("United States")
```

## Least efficient and most efficient

```{r}
means_crs$country[means_crs$efficiencies == max(means_crs$efficiencies)]
means_crs$country[means_crs$efficiencies == min(means_crs$efficiencies)]

```

## 1on1 DEA vs full DEA

```{r}

oneonone <- data_crs %>%
  select(dmu, efficiencies)

names(oneonone)[length(names(oneonone))] <- "full_dea"

for (i in 1:4) {
  for (j in 1:5) {
    
    # read file and merge it
    oneonone <- merge(oneonone, select(read_csv(paste("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/dea_results_113_io_crs_", as.character(i),  as.character(j), ".csv", sep = ""), show_col_types = FALSE), dmu, efficiencies), by = "dmu")
    
    # rename new column  
    names(oneonone)[ncol(oneonone)] <- paste(as.character(i), as.character(j), sep = "")
  }
}
```

```{r}
oneonone_correlation <- as.data.frame(cor(oneonone[2:ncol(oneonone)]))

write_csv(oneonone_correlation, "D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/oneonone_correlation.csv" )
```

![](oneonone.PNG)

Sames output means same efficiency.

## years vs efficiency

```{r}
data_crs %>%
  # filter(efficiencies <= quantile(data_crs$efficiencies)[2]) %>%
  filter(country %in% c("Germany", "United States", "France", "Thailand", "Ghana", "South Africa")) %>%
  ggplot(aes(year, efficiencies))+
  geom_point(aes(
    color=country
    )
  )+
  geom_line(aes(
    color=country
    )
  )

```

## Efficiencies per continent (all years)

```{r}
data_crs %>%
  # filter(continent == "Africa") %>%
  # filter(year %in% c(1990:1999)) %>%

  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(
                color=year
              )
              )
```

```{r}
data_crs %>%
  # filter(continent == "Africa") %>%
  filter(year %in% c(1990:1999)) %>%

  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(
                color=year
              )
              )
```

```{r}
data_crs %>%
  # filter(continent == "Africa") %>%
  filter(year %in% c(2000:2009)) %>%

  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(
                color=year
              )
              )
```

```{r}

data_crs %>%
  # filter(continent == "Africa") %>%
  filter(year %in% c(2010:2019)) %>%

  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              aes(
                color=year
              )
              )


```

In 90s not data about Africa, in 10 no data about Americas...not even USA
