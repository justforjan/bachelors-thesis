---
title: "BA - DEA"
output: html_notebook
---

# load libraries

```{r}
library(tidyverse)
library(deaR)
library(ggplot2)
library(countrycode)

```

# Preparation

## Select data to be used and set parameter

| Attempt | DMUs | No. of inputs | No. of outputs |
|---------|------|---------------|----------------|
| 3       | 2201 | 4             | 4              |
| 4       | 2332 | 3             | 3              |
| 5       | 2594 | 2             | 3              |
| 6       | 4421 | 2             | 3              |
| 7       | 4037 | 2             | 3              |
| 8       | 5533 | 2             | 2              |
| 9       | 4232 | 2             | 3              |
| 10      | 5605 | 1             | 2              |
| 11      | 4232 | 2             | 3              |

```{r}
# Chose the attempt
attempt = 8

# Number of in- and outputs -> checl struture of selected data set!
number_of_inputs <- 2
number_of_outputs <- 2

# location of inputs and outputs
input_cols <- c()
output_cols <- c()

# only from 1990?
from_1990 <- "no"

# only one year?
only_one_year <- 0 # 0 means no

# only one country?
only_one_country <- "Germany" # empty string means no

orientation <- "io"
# io: input oriented
# oo: output oriented

return_to_scale <- "vrs"
# crs: constant return to scale
# vrs: variable return to scale
# nirs: non-increasing
# ndrs: non-decreasing
# grs: generalized
```

## Load data

```{r}
data = read_csv(paste("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/final_", as.character(attempt), ".csv", sep = ""), show_col_types = FALSE)
str(data)
```

### Apply chosen selection

```{r}

if (from_1990 != "no") {
  data <- data %>%
    filter(year >= 1990)
}

if (only_one_year != 0) {
  data <- data %>%
    filter(year == only_one_year)
}

if (only_one_country != "") {
  data <- data %>%
    filter(country == only_one_country)
}
  
```

## Combine country and year to one string to use it as a name for the DMUs

```{r}
data$dmu <- str_c(data$country, "_", data$year)
data$country <- NULL
data$year <- NULL
data <- data %>% relocate(dmu)
```

# DEA

```{r}

# Documentation: https://cran.r-project.org/web/packages/deaR/deaR.pdf

if (length(input_cols) == 0) {
  model_data <- read_data(data, 
                        ni=number_of_inputs, 
                        no=number_of_outputs, 
                        dmus = 1)
  
} else {
  model_data <- read_data(data, 
                        ni=number_of_inputs, 
                        no=number_of_outputs, 
                        inputs=input_cols,
                        outputs=output_cols,
                        dmus = 1)
}


result <- model_basic(model_data, orientation = orientation, rts=return_to_scale)
```

## Efficiencies and Targets

```{r}
# Efficiencies
eff <- as.data.frame(efficiencies(result))
# add column for dmu names
eff$dmu <- rownames(eff)
# delete rownames
rownames(eff) <- NULL
# Rename efficiency column
colnames(eff)[1] <- "efficiencies"

# get targets
targets <- as.data.frame(targets(result))
# add column for dmu names
targets$dmu <- rownames(targets)
# delte rownames
rownames(targets) <- NULL
```

## Merge all together

```{r}
data_and_results <- list(
  data,
  eff,
  targets
)

data_dea <- data_and_results %>% reduce(full_join, by="dmu")
```

```{r}
data_dea <- data_dea %>% relocate(efficiencies, .after = dmu)
```

## Split um dmu column to country and year but keep dmu column

```{r}
data_dea <- separate(data_dea, dmu, c("country", "year"), "_", remove=FALSE)
```

## Add continents

```{r}
data_dea$continent <- countrycode(sourcevar = data_dea$country,
                               origin = "country.name",
                               destination = "continent")
```

## export as csv

create name for the file

```{r}
filename <- paste(as.character(attempt), "_", orientation, "_", return_to_scale, sep = "")

if (from_1990 != "no") {
  filename <- paste(filename, "_", "from1990", sep = "")
}

if (only_one_year != 0) {
  filename <- paste(filename, "_", as.character(only_one_year), sep = "")  
}

if (only_one_country != "") {
  filename <- paste(filename, "_", only_one_country, sep = "")    
}

```

```{r}
write_csv(data_dea, paste("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/dea_results_", filename, ".csv", sep = ""))
```
