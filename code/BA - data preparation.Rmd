---
title: "Bachelor's Thesis - Data Preparation"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
editor_options: 
  markdown: 
    wrap: 72
---

# Data Preparation

## load libaries

```{r}
library(tidyverse)
library(deaR)
library(ggplot2)
library(countrycode)
```

women_in_parliament, basic_sanitation, basic_water_source, electricity,
employment_rate, material_footprint, forest_area, mean_years_in_school,
air_pollution, health_worker, red_list, poverty, life_expectancy,
income, income_share_20, CO2, murder

# Prepare individual data sets

## Load data

### **Gapminder**

```{r}
# Input
# 5:
women_in_parliament <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/percentage_women_in_parliament.csv",show_col_types = FALSE)
# 6:
basic_sanitation <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/at_least_basic_sanitation_overall_access_percent.csv",show_col_types = FALSE)
basic_water_source <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/at_least_basic_water_source_overall_access_percent.csv",show_col_types = FALSE)
# 7:
electricity <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/access_to_electricity.csv",show_col_types = FALSE)
# 8:
employment_rate <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/aged_15plus_employment_rate_percent.csv",show_col_types = FALSE)
# 12:
material_footprint <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/matfootp_cap.csv",show_col_types = FALSE)
# 15:
forest_area <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/forest_area.csv",show_col_types = FALSE)

# democracy <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/demox_eiu.csv",show_col_types = FALSE)

# Output
# 1:
poverty <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/extreme_poverty_percent_people_below_190_a_day.csv",show_col_types = FALSE)
# 3:
life_expectancy <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/life_expectancy_years.csv",show_col_types = FALSE)
# 8:
income <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/income_per_person_gdppercapita_ppp_inflation_adjusted.csv",show_col_types = FALSE)
# 10:
income_share_20 <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/income_share_of_poorest_20percent.csv",show_col_types = FALSE)
# 13:
CO2 <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/co2_emissions_tonnes_per_person.csv",show_col_types = FALSE)
# deaths_natural_disaster <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/number_of_natural_disaster_death_tot.csv",show_col_types = FALSE) # Total -> has to be calculated to /100k
# 16:
murder <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/murder_per_100000_people.csv",show_col_types = FALSE)

```

### **OurWorldInData**

```{r}
# 3:
health_worker <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/OurWorldInData/physicians-per-1000-people.csv",show_col_types = FALSE)
# 4:
mean_years_in_school <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/OurWorldInData/mean-years-of-schooling.csv",show_col_types = FALSE)
# 11:
air_pollution <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/OurWorldInData/PM25-air-pollution.csv",show_col_types = FALSE)
# 15:
red_list <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/OurWorldInData/red-list-index.csv",show_col_types = FALSE)
```

### Adaption of OurWorldInData data sets

```{r}
health_worker[,2] <- NULL
mean_years_in_school[,2] <- NULL
air_pollution[,2] <- NULL
red_list[,2] <- NULL

colnames(health_worker) <- c("country", "year", "value")
colnames(mean_years_in_school) <- c("country", "year", "value")
colnames(air_pollution) <- c("country", "year", "value")
colnames(red_list) <- c("country", "year", "value")
```

## Remove years 1949 and earlier and 2021 and later

```{r}
drops <- as.character(c(1700:1949, 2021:2200))

# Gapminder

women_in_parliament <- women_in_parliament[ , !(names(women_in_parliament) %in% drops)]
basic_sanitation <- basic_sanitation[ , !(names(basic_sanitation) %in% drops)]
basic_water_source <- basic_water_source[ , !(names(basic_water_source) %in% drops)]
electricity <- electricity[ , !(names(electricity) %in% drops)]
employment_rate <- employment_rate[ , !(names(employment_rate) %in% drops)]
material_footprint <- material_footprint[ , !(names(material_footprint) %in% drops)]
forest_area <- forest_area[ , !(names(forest_area) %in% drops)]
poverty <- poverty[ , !(names(poverty) %in% drops)]
life_expectancy <- life_expectancy[ , !(names(life_expectancy) %in% drops)]
income <- income[ , !(names(income) %in% drops)]
income_share_20 <- income_share_20[ , !(names(income_share_20) %in% drops)]
CO2 <- CO2[ , !(names(CO2) %in% drops)]
murder <- murder[ , !(names(murder) %in% drops)]

# OurWorldInData

mean_years_in_school <- subset(mean_years_in_school, !(year %in% drops))
air_pollution <- subset(air_pollution, !(year %in% drops))
health_worker <- subset(health_worker, !(year %in% drops))
red_list <- subset(red_list, !(year %in% drops))

```

## Change tables from wide to long (Gapminder)

```{r}
women_in_parliament <- women_in_parliament %>% gather("year", "value", -country)
basic_sanitation <- basic_sanitation %>% gather("year", "value", -country)
basic_water_source <- basic_water_source %>% gather("year", "value", -country)
electricity <- electricity %>% gather("year", "value", -country)
employment_rate <- employment_rate %>% gather("year", "value", -country)
material_footprint <- material_footprint %>% gather("year", "value", -country)
forest_area <- forest_area %>% gather("year", "value", -country)
poverty <- poverty %>% gather("year", "value", -country)
life_expectancy <- life_expectancy %>% gather("year", "value", -country)
income <- income %>% gather("year", "value", -country)
income_share_20 <- income_share_20 %>% gather("year", "value", -country)
CO2 <- CO2 %>% gather("year", "value", -country)
murder <- murder %>% gather("year", "value", -country)
```

Change data types of colums

```{r}
# Values
income$value <- as.numeric(gsub("k", "e3", income$value))/1000 # divided by 1000 to avoid different orders of magnitude within dataset

# Years
women_in_parliament <- women_in_parliament %>% mutate(year = as.numeric(year))
basic_sanitation <- basic_sanitation %>% mutate(year = as.numeric(year))
basic_water_source <- basic_water_source %>% mutate(year = as.numeric(year))
electricity <- electricity %>% mutate(year = as.numeric(year))
employment_rate <- employment_rate %>% mutate(year = as.numeric(year))
material_footprint <- material_footprint %>% mutate(year = as.numeric(year))
forest_area <- forest_area %>% mutate(year = as.numeric(year))
mean_years_in_school <- mean_years_in_school %>% mutate(year = as.numeric(year))
health_worker <- health_worker %>% mutate(year = as.numeric(year))
air_pollution <- air_pollution %>% mutate(year = as.numeric(year))
red_list <- red_list %>% mutate(year = as.numeric(year))
poverty <- poverty %>% mutate(year = as.numeric(year))
life_expectancy <- life_expectancy %>% mutate(year = as.numeric(year))
income <- income %>% mutate(year = as.numeric(year))
income_share_20 <- income_share_20 %>% mutate(year = as.numeric(year))
CO2 <- CO2 %>% mutate(year = as.numeric(year))
murder <- murder %>% mutate(year = as.numeric(year))
```

## General information about data sets

```{r}
titles <- c(
"women_in_parliament",
"basic_sanitation",
"basic_water_source",
"electricity",
"employment_rate",
"material_footprint",
"forest_area",
"mean_years_in_school",
"air_pollution",
"health_worker",
"red_list",
"poverty",
"life_expectancy",
"income",
"income_share_20",
"CO2",
"murder"
)

earliest <- c(
min(women_in_parliament$year),
min(basic_sanitation$year),
min(basic_water_source$year),
min(electricity$year),
min(employment_rate$year),
min(material_footprint$year),
min(forest_area$year),
min(mean_years_in_school$year),
min(health_worker$year),
min(air_pollution$year),
min(red_list$year),
min(poverty$year),
min(life_expectancy$year),
min(income$year),
min(income_share_20$year),
min(CO2$year),
min(murder$year)
)

latest <- c(
max(women_in_parliament$year),
max(basic_sanitation$year),
max(basic_water_source$year),
max(electricity$year),
max(employment_rate$year),
max(material_footprint$year),
max(forest_area$year),
max(mean_years_in_school$year),
max(health_worker$year),
max(air_pollution$year),
max(red_list$year),
max(poverty$year),
max(life_expectancy$year),
max(income$year),
max(income_share_20$year),
max(CO2$year),
max(murder$year)
)

datapoints <- c(
nrow(women_in_parliament),
nrow(basic_sanitation),
nrow(basic_water_source),
nrow(electricity),
nrow(employment_rate),
nrow(material_footprint),
nrow(forest_area),
nrow(mean_years_in_school),
nrow(air_pollution),
nrow(health_worker),
nrow(red_list),
nrow(poverty),
nrow(life_expectancy),
nrow(income),
nrow(income_share_20),
nrow(CO2),
nrow(murder)
)

zero_or_below <- c(
(min(women_in_parliament$value, na.rm = TRUE) <= 0),
(min(basic_sanitation$value, na.rm = TRUE) <= 0),
(min(basic_water_source$value, na.rm = TRUE) <= 0),
(min(electricity$value, na.rm = TRUE) <= 0),
(min(employment_rate$value, na.rm = TRUE) <= 0),
(min(material_footprint$value, na.rm = TRUE) <= 0),
(min(forest_area$value, na.rm = TRUE) <= 0),
(min(mean_years_in_school$value, na.rm = TRUE) <= 0),
(min(air_pollution$value, na.rm = TRUE) <= 0),
(min(health_worker$value, na.rm = TRUE) <= 0),
(min(red_list$value, na.rm = TRUE) <= 0),
(min(poverty$value, na.rm = TRUE) <= 0),
(min(life_expectancy$value, na.rm = TRUE) <= 0),
(min(income$value, na.rm = TRUE) <= 0),
(min(income_share_20$value, na.rm = TRUE) <= 0),
(min(CO2$value, na.rm = TRUE) <= 0),
(min(murder$value, na.rm = TRUE) <= 0)
)

dp_per_year <- datapoints / (latest - earliest)

overview <- data.frame(titles, earliest, latest, datapoints, dp_per_year, zero_or_below)
overview[order(overview$dp_per_year, decreasing = TRUE),]
```

Using data sets that have values of 0 or less might be an issue later on
when inputting the data into the DEA, unless the 0 values get filtered
out anyways while merging.

# Merge data frames

We want to create multiple data sets all comprising a different set of
data sets. Merging all data sets results in too less dmus and too many
dimensions and this results in all DMUs having an efficiency of either 1
or very close to 1. The plan is to check, which combination of around 4
in and 4 outputs results in a high enough number of DMUs.

We want as many DMUs as possible. Therefore, it makes sense to use data
sets with large time periods (e.g. women_in_parliament) and many
datapoints (e.g. life_expectency, CO2, income).

The amount of data point of the data set with the most data points
automatically represents the maximum number of potential DMUs.

Data sets that we can ignore already because of too little time frames
and too few data points:

-   air_pollution

-   basic_sanitation

-   basic_water_source

Data sets that (as of now) look very promising:

-   women_in_parliament

-   life_expectancy

-   income

-   CO2

## Attempt 4

| Input | Output |
|-------|--------|
|       |        |
|       |        |
|       |        |

## Attempt 3

| Input               | Output          |
|---------------------|-----------------|
| electricity         | life_expectancy |
| forest_area         | income          |
| women_in_parliament | CO2             |
| health_worker       | employment_rate |

```{r}
all_data <- list(
  women_in_parliament,
  electricity,
  CO2,
  forest_area,
  life_expectancy,
  income,
  health_worker,
  employment_rate
)

final_3 <- all_data %>% reduce(full_join, by = c("country", "year"))

colnames(final_3) <- c(
  "country",
  "year",
  "women_in_parliament",
  "electricity",
  "CO2",
  "forest_area",
  "life_expectancy",
  "income",
  "health_worker",
  "employment_rate"
)

final_3 <- as.data.frame(final_3)

final_3 <- drop_na(final_3)

nrow(final_3)
```

-\> 2201 DMUs

### Check for 0 values

```{r}
min(final_3$women_in_parliament)
min(final_3$forest_area)
# min(final$mean_years_in_school)
# min(final$poverty)
min(final_3$CO2)
```

```{r}
print("0 women in parliament:")
unique(final_3$country[final_3$women_in_parliament <= 0])
print("0 forest area:")
unique(final_3$country[final_3$forest_area <= 0])
```

Assign very low values where values are 0

```{r}
final_3[final_3 == 0] <- 0.0001
```

```{r}
min(final_3$women_in_parliament)
min(final_3$forest_area)
# min(final$mean_years_in_school)
# min(final$poverty)
min(final_3$CO2)
```

```{r}
final_3$dmu <- str_c(final_3$country, "_", final_3$year)
final_3$country <- NULL
final_3$year <- NULL
final_3 <- final_3 %>% relocate(dmu)
```

### DEA - Attempt 3

```{r}

# Documentation: https://cran.r-project.org/web/packages/deaR/deaR.pdf

# Number of in- and outputs
number_of_inputs <- 4
number_of_outputs <- 4

orientation <- "io"
# io: input oriented
# oo: output oriented

return_to_scale <- "vrs"
# crs: constant return to scale
# vrs: variable return to scale
# nirs: non-increasing
# ndrs: non-decreasing
# grs: generalized


model_data <- read_data(final_3, ni=number_of_inputs, no=number_of_outputs, dmus = 1)


result_8 <- model_basic(model_data, orientation = orientation, rts=return_to_scale)

```

Calculate efficiencies and target values

```{r}
# Efficiencies
eff <- as.data.frame(efficiencies(result_8))
# add column for dmu names
eff$dmu <- rownames(eff)
# delete rownames
rownames(eff) <- NULL
# Rename efficiency column
colnames(eff)[1] <- "efficiencies"

# get targets
targets <- as.data.frame(targets(result_8))
# add column for dmu names
targets$dmu <- rownames(targets)
# delte rownames
rownames(targets) <- NULL
```

Merge efficiencies, targets and the original data into one data fram

```{r}
data_and_results <- list(
  final_3,
  eff,
  targets
)

data_dea_3 <- data_and_results %>% reduce(full_join, by="dmu")
```

Relocate the efficiencies column

```{r}
data_dea_3 <- data_dea_3 %>% relocate(efficiencies, .after = dmu)
```

Seperate the DMU column into country and year but keep the dmu column

```{r}
data_dea_3 <- separate(data_dea_3, dmu, c("country", "year"), "_", remove=FALSE)
```

Add the continent to each DMU

```{r}
data_dea_3$continent <- countrycode(sourcevar = data_dea_3$country,
                               origin = "country.name",
                               destination = "continent")
```

### Visualization

```{r}
data_dea_3 %>%
  filter(continent == "Africa") %>%
  ggplot(aes(year, efficiencies))+
  geom_point(aes(
    # color=country
  )
  )+
  theme(axis.text.x=element_text(angle = -90, hjust = 0))
```

```{r}
data_dea_3 %>%
  # filter(continent == "Africa") %>%
  ggplot(aes(continent, efficiencies))+
  geom_boxplot()+
  geom_jitter(width = 0.1,
              alpha = 0.5,
              # aes(
              #   color=year
              #   )
              )
```

## Attempt 2

In this attempt we try to cover only 8 dimensions in total.

**Input:**

-   women_in_parliament

-   electricity

-   CO2

-   mean_years_in_school

**Output:**

-   life_expectancy

-   income

-   income_share_20

-   employment_rate

```{r}
all_data <- list(
  women_in_parliament,
  electricity,
  CO2,
  mean_years_in_school,
  life_expectancy,
  income,
  income_share_20,
  employment_rate
)

final <- all_data %>% reduce(full_join, by = c("country", "year"))

colnames(final) <- c(
  "women_in_parliament",
  "electricity",
  "CO2",
  "mean_years_in_school",
  "life_expectancy",
  "income",
  "income_share_20",
  "employment_rate"
)

final <- as.data.frame(final)

final <- drop_na(final)
```

### Check for 0 values

```{r}
min(final$women_in_parliament)
min(final$mean_years_in_school)
min(final$CO2)
```

Count how many 0 values in CO2

```{r}
sum(final$CO2 <= 0)
```

Only 2 values 0 or less. I will delete these two observations.

```{r}
final <- subset(final, CO2>0)
```

```{r}
nrow(final)
```

## Attempt 1 - All data sets

17 in total

```{r}
# Create list of all data frames
all_data <- list(
  women_in_parliament,
  basic_sanitation,
  basic_water_source,
  electricity,
  employment_rate,
  material_footprint,
  forest_area,
  mean_years_in_school,
  health_worker,
  air_pollution,
  red_list,
  poverty,
  life_expectancy,
  income,
  income_share_20,
  CO2,
  murder
)
```

```{r}

# Merge all data frame together by the country attribute

final <- all_data %>% reduce(full_join, by=c("country", "year"))
```

```{r}

# Change column names to something meaningful
colnames(final) <- c(
  "country",
  "year",
  "women_in_parliament",
  "basic_sanitation",
  "basic_water_source",
  "electricity",
  "employment_rate",
  "material_footprint",
  "forest_area",
  "mean_years_in_school",
  "air_pollution",
  "health_worker",
  "red_list",
  "poverty",
  "life_expectancy",
  "income",
  "income_share_20",
  "CO2",
  "murder"
  )

# convert tibble to data frame
final <- as.data.frame(final)
```

### Are there any quirks in the resulting data frame?

-   Upper middle income
-   World
-   USSR

-\> OurWorldInData also shows regional data, Gapminder does not. When
filtering out all country-year combinations with NA values, the regional
data will be filtered out as well. We will check that later.

### Delete DMUs with NAs

```{r}
final <- drop_na(final)
```

### Find out year with most countries

```{r}
year <- table(final$year)
year <- as.data.frame(year)
year
```

### Check for negative or zero values

```{r}
min(final$women_in_parliament)
min(final$forest_area)
min(final$mean_years_in_school)
min(final$poverty)
min(final$CO2)
```

In the poverty column many 0 values can be found. Instead of just
deleting the columns, I will do the merger again but without poverty.

```{r}
nrow(final)

all_data <- list(
  women_in_parliament,
  basic_sanitation,
  basic_water_source,
  electricity,
  employment_rate,
  material_footprint,
  forest_area,
  mean_years_in_school,
  health_worker,
  air_pollution,
  red_list,
  # poverty,
  life_expectancy,
  income,
  income_share_20,
  CO2,
  murder
)

final <- all_data %>% reduce(full_join, by=c("country", "year"))

# Change column names to something meaningful
colnames(final) <- c(
  "country",
  "year",
  "women_in_parliament",
  "basic_sanitation",
  "basic_water_source",
  "electricity",
  "employment_rate",
  "material_footprint",
  "forest_area",
  "mean_years_in_school",
  "air_pollution",
  "health_worker",
  "red_list",
  # "poverty",
  "life_expectancy",
  "income",
  "income_share_20",
  "CO2",
  "murder"
  )

# convert tibble to data frame
final <- as.data.frame(final)

final <- drop_na(final)

nrow(final)
```

As we can see, we did not get any more DMUs by not including poverty.
What a shame. 259 DMUs are way too less for 16 Dimensions. We need to
have less dimensions.

```{r}
final_all <- final
final_all$dmu <- str_c(final_all$country, "_", final_all$year)
final_all$country <- NULL
final_all$year <- NULL
final_all <- final_all %>% relocate(dmu)
```

### Save result as csv

```{r}
write_csv(final_all, "D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/all_datasets_all_dmus.csv")
# write_csv(final, "D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/country_data_general.csv")
```

## 
