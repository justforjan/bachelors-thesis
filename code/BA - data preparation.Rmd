---
title: "Bachelor's Thesis - Data Preparation"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

# Data Preparation

## What data sets to use

Input:


Output:


## load libaries

```{r}
library(tidyverse)
library(deaR)
library(ggplot2)
library(countrycode)
```

women_in_parliament,
basic_sanitation,
basic_water_source,
electricity,
employment_rate,
material_footprint,
forest_area,
mean_years_in_school,
air_pollution,
health_worker,
red_list,
poverty,
life_expactancy,
income,
income_share_20,
CO2,
murder

## load data


**Gapminder**:
```{r}
# Input
# 5:
women_in_parliament <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/percentage_women_in_parliament.csv",show_col_types = FALSE)
# 6:
basic_sanitation <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/at_least_basic_sanitation_overall_access_percent.csv",show_col_types = FALSE)
basic_water_source <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/at_least_basic_water_source_overall_access_percent.csv",show_col_types = FALSE)
# 7:
electricity <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/access_to_electricity.csv",show_col_types = FALSE)
# 8:
employment_rate <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/aged_15plus_employment_rate_percent.csv",show_col_types = FALSE)
# 12:
material_footprint <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/matfootp_cap.csv",show_col_types = FALSE)
# 15:
forest_area <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/forest_area.csv",show_col_types = FALSE)

# democracy <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/demox_eiu.csv",show_col_types = FALSE)

# Output
# 1:
poverty <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/extreme_poverty_percent_people_below_190_a_day.csv",show_col_types = FALSE)
# 3:
life_expactancy <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/life_expectancy_years.csv",show_col_types = FALSE)
# 8:
income <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/income_per_person_gdppercapita_ppp_inflation_adjusted.csv",show_col_types = FALSE)
# 10:
income_share_20 <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/income_share_of_poorest_20percent.csv",show_col_types = FALSE)
# 13:
CO2 <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/co2_emissions_tonnes_per_person.csv",show_col_types = FALSE)
# deaths_natural_disaster <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/number_of_natural_disaster_death_tot.csv",show_col_types = FALSE) # Total -> has to be calculated to /100k
# 16:
murder <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/gapminder/murder_per_100000_people.csv",show_col_types = FALSE)

```

**OurWorldInData**:
```{r}
# 3:
health_worker <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/OurWorldInData/physicians-per-1000-people.csv",show_col_types = FALSE)
# 4:
mean_years_in_school <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/OurWorldInData/mean-years-of-schooling.csv",show_col_types = FALSE)
# 11:
air_pollution <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/OurWorldInData/PM25-air-pollution.csv",show_col_types = FALSE)
# 15:
red_list <- read_csv("D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/raw_data/OurWorldInData/red-list-index.csv",show_col_types = FALSE)
```

## OurworldInData Adaption

```{r}
health_worker[,2] <- NULL
mean_years_in_school[,2] <- NULL
air_pollution[,2] <- NULL
red_list[,2] <- NULL

colnames(health_worker) <- c("country", "year", "value")
colnames(mean_years_in_school) <- c("country", "year", "value")
colnames(air_pollution) <- c("country", "year", "value")
colnames(red_list) <- c("country", "year", "value")
```

## Remove years 1949 and earlier adn 2021 and later

(Not necessary, filtered out later anyways)

```{r}
drops <- as.character(c(1700:1949, 2021:2200))

# Gapminder

women_in_parliament <- women_in_parliament[ , !(names(women_in_parliament) %in% drops)]
basic_sanitation <- basic_sanitation[ , !(names(basic_sanitation) %in% drops)]
basic_water_source <- basic_water_source[ , !(names(basic_water_source) %in% drops)]
electricity <- electricity[ , !(names(electricity) %in% drops)]
employment_rate <- employment_rate[ , !(names(employment_rate) %in% drops)]
material_footprint <- material_footprint[ , !(names(material_footprint) %in% drops)]
forest_area <- forest_area[ , !(names(forest_area) %in% drops)]
poverty <- poverty[ , !(names(poverty) %in% drops)]
life_expactancy <- life_expactancy[ , !(names(life_expactancy) %in% drops)]
income <- income[ , !(names(income) %in% drops)]
income_share_20 <- income_share_20[ , !(names(income_share_20) %in% drops)]
CO2 <- CO2[ , !(names(CO2) %in% drops)]
murder <- murder[ , !(names(murder) %in% drops)]

# OurWorldInData

mean_years_in_school <- subset(mean_years_in_school, !(year %in% drops))
air_pollution <- subset(air_pollution, !(year %in% drops))
health_worker <- subset(health_worker, !(year %in% drops))
red_list <- subset(red_list, !(year %in% drops))

```

## Change tables from wide to long (Gapminder)

```{r}
women_in_parliament <- women_in_parliament %>% gather("year", "value", -country)
basic_sanitation <- basic_sanitation %>% gather("year", "value", -country)
basic_water_source <- basic_water_source %>% gather("year", "value", -country)
electricity <- electricity %>% gather("year", "value", -country)
employment_rate <- employment_rate %>% gather("year", "value", -country)
material_footprint <- material_footprint %>% gather("year", "value", -country)
forest_area <- forest_area %>% gather("year", "value", -country)
poverty <- poverty %>% gather("year", "value", -country)
life_expactancy <- life_expactancy %>% gather("year", "value", -country)
income <- income %>% gather("year", "value", -country)
income_share_20 <- income_share_20 %>% gather("year", "value", -country)
CO2 <- CO2 %>% gather("year", "value", -country)
murder <- murder %>% gather("year", "value", -country)
```

## Range of years of datasets

```{r}
titles <- c(
"women_in_parliament",
"basic_sanitation",
"basic_water_source",
"electricity",
"employment_rate",
"material_footprint",
"forest_area",
"mean_years_in_school",
"air_pollution",
"health_worker",
"red_list",
"poverty",
"life_expactancy",
"income",
"income_share_20",
"CO2",
"murder"
)

earliest <- c(
min(women_in_parliament$year),
min(basic_sanitation$year),
min(basic_water_source$year),
min(electricity$year),
min(employment_rate$year),
min(material_footprint$year),
min(forest_area$year),
min(mean_years_in_school$year),
min(health_worker$year),
min(air_pollution$year),
min(red_list$year),
min(poverty$year),
min(life_expactancy$year),
min(income$year),
min(income_share_20$year),
min(CO2$year),
min(murder$year)
)

latest <- c(
max(women_in_parliament$year),
max(basic_sanitation$year),
max(basic_water_source$year),
max(electricity$year),
max(employment_rate$year),
max(material_footprint$year),
max(forest_area$year),
max(mean_years_in_school$year),
max(health_worker$year),
max(air_pollution$year),
max(red_list$year),
max(poverty$year),
max(life_expactancy$year),
max(income$year),
max(income_share_20$year),
max(CO2$year),
max(murder$year)
)

overview <- data.frame(titles, earliest, latest)

```

```{r}

```



## Merge data frames

```{r}
# make year columns numerical
women_in_parliament <- women_in_parliament %>% mutate(year = as.numeric(year))
basic_sanitation <- basic_sanitation %>% mutate(year = as.numeric(year))
basic_water_source <- basic_water_source %>% mutate(year = as.numeric(year))
electricity <- electricity %>% mutate(year = as.numeric(year))
employment_rate <- employment_rate %>% mutate(year = as.numeric(year))
material_footprint <- material_footprint %>% mutate(year = as.numeric(year))
forest_area <- forest_area %>% mutate(year = as.numeric(year))
mean_years_in_school <- mean_years_in_school %>% mutate(year = as.numeric(year))
health_worker <- health_worker %>% mutate(year = as.numeric(year))
air_pollution <- air_pollution %>% mutate(year = as.numeric(year))
red_list <- red_list %>% mutate(year = as.numeric(year))
poverty <- poverty %>% mutate(year = as.numeric(year))
life_expactancy <- life_expactancy %>% mutate(year = as.numeric(year))
income <- income %>% mutate(year = as.numeric(year))
income_share_20 <- income_share_20 %>% mutate(year = as.numeric(year))
CO2 <- CO2 %>% mutate(year = as.numeric(year))
murder <- murder %>% mutate(year = as.numeric(year))

# Create list of all data frames
all_data <- list(
  women_in_parliament,
  basic_sanitation,
  basic_water_source,
  electricity,
  employment_rate,
  material_footprint,
  forest_area,
  mean_years_in_school,
  health_worker,
  air_pollution,
  red_list,
  poverty,
  life_expactancy,
  income,
  income_share_20,
  CO2,
  murder
)
```

```{r}

# Merge all data frame together by the country attribute

final <- all_data %>% reduce(full_join, by=c("country", "year"))
```


```{r}

# Change column names to something meaningful
colnames(final) <- c(
  "country",
  "year",
  "women_in_parliament",
  "basic_sanitation",
  "basic_water_source",
  "electricity",
  "employment_rate",
  "material_footprint",
  "forest_area",
  "mean_years_in_school",
  "air_pollution",
  "health_worker",
  "red_list",
  "poverty",
  "life_expactancy",
  "income",
  "income_share_20",
  "CO2",
  "murder"
  )

# convert tibble to data frame
final <- as.data.frame(final)
```

# Are there any quirks in the resulting data frame?

- Upper middle income
- World
- USSR

-> OurWorldInData also shows regional data, Gapminder does not. When filtering out all country-year combinations with NA values, the regional data will be filtered out as well. We will check that later.

## Adap data types
```{r}
str(final)
```

- Income not numeric
- CO2 not numeric

```{r}

# adapt data types
final$income <- as.numeric(gsub("k", "e3", final$income))/1000 # divided by 1000 to avoid different orders of magnitude within dataset
# final$CO2 <- as.numeric(final$CO2)
str(final)
```

## Delete DMUs with NAs

```{r}
final <- drop_na(final)
```

## Find out year with most countries

```{r}
year <- table(final$year)
year <- as.data.frame(year)
year
```

## Check for negative or zero values

```{r}
min(final$women_in_parliament)
min(final$basic_sanitation)
min(final$basic_water_source)
min(final$electricity)
min(final$employment_rate)
min(final$material_footprint)
min(final$forest_area)
min(final$mean_years_in_school)
min(final$health_worker)
min(final$air_pollution)
min(final$red_list)
min(final$poverty)
min(final$life_expactancy)
min(final$income)
min(final$income_share_20)
min(final$CO2)
min(final$murder)

```

In the poverty column many 0 values can be found. For now, I will just delete this column

```{r}
final$poverty <- NULL
```


```{r}
final_all <- final
final_all$dmu <- str_c(final_all$country, "_", final_all$year)
final_all$country <- NULL
final_all$year <- NULL
final_all <- final_all %>% relocate(dmu)
```

## Save result as csv

```{r}
write_csv(final_all, "D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/all_datasets_all_dmus.csv")
# write_csv(final, "D:/Daten/Bildung/HS Mannheim/BA/bachelors-thesis/processed_data/country_data_general.csv")
```




